name: Auto Pull Request

on:
  workflow_run:
    workflows: ["Java CI with Maven"]
    types:
      - completed

jobs:
  create-pr:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v3
      
      - name: Create Pull Request
        uses: actions/github-script@v6
        with:
          script: |
            const { repo, owner } = context.repo;
            const branch = context.payload.workflow_run.head_branch;
            
            let base = '';
            if (branch === 'develop') {
              base = 'main';
            } else if (branch.startsWith('feature/')) {
              base = 'develop';
            } else {
              console.log(`Branch '${branch}' does not match patterns 'develop' or 'feature/*'. Skipping PR creation.`);
              return;
            }
            
            console.log(`Creating PR from ${branch} to ${base}`);
            
            try {
              const { data: prs } = await github.rest.pulls.list({
                owner,
                repo,
                head: `${owner}:${branch}`,
                base: base,
                state: 'open'
              });
              
              if (prs.length > 0) {
                console.log('PR already exists');
                return;
              }
              
              await github.rest.pulls.create({
                owner,
                repo,
                head: branch,
                base: base,
                title: `Auto PR: ${branch} to ${base}`,
                body: `Automated PR created after successful CI run on ${branch}.`
              });
            } catch (error) {
              console.log('Error creating PR:', error);
            }
